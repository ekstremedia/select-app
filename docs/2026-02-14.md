# 2026-02-14 — Production Deployment to select.huske.app

## Subdomain Setup

Created `select.huske.app` subdomain to serve the Laravel app via Docker.

### 1. Apache Virtual Host

Created `/etc/apache2/sites-available/select-huske.conf` — reverse proxy to Docker container on port 8000:

```apache
<VirtualHost *:80>
    ServerName select.huske.app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    ErrorLog ${APACHE_LOG_DIR}/select-huske-error.log
    CustomLog ${APACHE_LOG_DIR}/select-huske-access.log combined
</VirtualHost>
```

Enabled with `sudo a2ensite select-huske.conf && sudo systemctl reload apache2`.

### 2. DNS (GoDaddy)

Added A record for `select` pointing to `185.14.97.143` (same IP as huske.app) with 600s TTL.

### 3. SSL Certificate

```bash
sudo certbot --apache -d select.huske.app
```

Certbot auto-created `select-huske-le-ssl.conf` and added HTTPS redirect to the HTTP vhost.

### 4. Docker Engine Installation

Docker was not installed on the server. Installed Docker Engine for Debian Bullseye:

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bullseye stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo groupadd docker
sudo usermod -aG docker terje
newgrp docker
```

Note: `sudo apt install docker` installs `wmdocker` (a window manager dock), NOT Docker Engine.

### 5. Production .env

Created `website/.env` with key differences from `.env.example`:

| Setting | Dev | Production |
|---------|-----|------------|
| APP_ENV | local | production |
| APP_DEBUG | true | false |
| APP_URL | http://select.test:8000 | https://select.huske.app |
| DB_EXTERNAL_PORT | 5432 | 5433 (host PostgreSQL on 5432) |
| REVERB_PORT | 8080 | 8082 (8080/8081 in use by other sites) |
| LOG_LEVEL | debug | warning |

### 6. Docker Startup & Fix

```bash
cd /home/terje/sites/select-app/website
docker compose up -d
```

Setup container ran successfully (composer install, key generate, migrations).

**500 error fix** — storage directories not writable:

```bash
docker compose exec app chmod -R 775 storage bootstrap/cache
docker compose exec app chown -R www-data:www-data storage bootstrap/cache
```

## Server Architecture

```
Browser → select.huske.app (HTTPS/443)
       → Apache reverse proxy
       → localhost:8000
       → Docker: select-nginx container
       → Docker: select-app (PHP-FPM)
       → Docker: select-db (PostgreSQL on internal network, exposed on host:5433)
```

## Port Allocations on Server

| Port | Service |
|------|---------|
| 8000 | Select app (Docker nginx) |
| 8080 | dev.ekstremedia.no Reverb |
| 8081 | ekstremedia.no Reverb |
| 8082 | Select Reverb (reserved, not yet active) |
| 5432 | Host PostgreSQL |
| 5433 | Select PostgreSQL (Docker, external) |

---

## Welcome Page — Vue 3 + PrimeVue v4 + Tailwind v4

Replaced the default Laravel 12 welcome page with a game-branded Vue 3 SPA.

### Frontend Stack Installed

```bash
cd website
yarn add vue @vitejs/plugin-vue primevue @primeuix/themes tailwindcss-primeui
```

### Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `package.json` | Modified | Added Vue 3, PrimeVue v4, Tailwind-PrimeUI deps |
| `vite.config.js` | Modified | Added `@vitejs/plugin-vue` plugin |
| `resources/js/app.js` | Rewritten | Vue 3 app + PrimeVue with Aura theme |
| `resources/css/app.css` | Modified | Added `tailwindcss-primeui`, `.vue` source scanning, class-based dark mode |
| `resources/js/composables/useI18n.js` | New | NO/EN i18n with localStorage persistence |
| `resources/js/composables/useDarkMode.js` | New | Dark/light toggle, system preference detection |
| `resources/js/pages/Welcome.vue` | New | Full welcome page component |
| `resources/views/welcome.blade.php` | Rewritten | Minimal Vue mount shell |
| `tests/Feature/WelcomePageTest.php` | New | PHPUnit tests for welcome route |

### Welcome Page Features

- **Hero**: Large "SELECT" title, animated acronym tiles (letters appear one by one, then sentence forms)
- **How to play**: 4-step card grid explaining the game
- **Example**: Letter tiles spelling S-E-L-E-C-T with example answer
- **CTA**: PrimeVue buttons — "Play now" / "Get the app"
- **Dark/light mode**: Toggle button, persists to localStorage, respects system preference
- **Language**: NO/EN toggle, Norwegian default, persists to localStorage
- **Responsive**: Mobile-first design with sm: breakpoints

### Tailwind v4 Dark Mode Fix

Tailwind v4 defaults to `@media (prefers-color-scheme: dark)` for `dark:` variants. For class-based toggle (`.dark` on `<html>`), added to `app.css`:

```css
@variant dark (&:where(.dark, .dark *));
```

### HTTPS Mixed Content Fix

Assets were generating `http://` URLs because Apache terminates SSL and proxies to Docker over HTTP. Two fixes applied:

1. **`bootstrap/app.php`**: Added `$middleware->trustProxies(at: '*')` to trust all proxies
2. **`AppServiceProvider.php`**: Added `URL::forceScheme('https')` in production

### Build

```bash
cd website && yarn build
```

Assets compiled to `public/build/` (~320KB JS, ~25KB CSS gzipped).

---

## Gullkorn Import Command

Created `php artisan gullkorn:import` to import legacy sentence data from the original IRC #select game.

### Problem

SQL files are MySQL dumps (backtick quoting, `ENGINE=InnoDB`, `LOCK TABLES`, `AUTO_INCREMENT`). Database is PostgreSQL.

### Solution

The command (`app/Console/Commands/ImportGullkornCommand.php`):
1. Creates PostgreSQL-native tables (SERIAL, TIMESTAMP)
2. Parses MySQL INSERT VALUES tuples with a custom parser (handles escaped quotes, commas in strings)
3. Converts MySQL-invalid dates (`2000-00-00`) to NULL
4. Batch inserts 500 rows at a time
5. Resets PostgreSQL sequences to max(id)

### Usage

```bash
dc exec select php artisan gullkorn:import                        # Both tables
dc exec select php artisan gullkorn:import --only=gullkorn_clean  # One table
```

### Tables

| Table | Description |
|-------|-------------|
| `gullkorn` | Original sentences, all data from #select |
| `gullkorn_clean` | Curated/cleaned version |

Both tables: `id`, `nick` (varchar 9), `setning` (text), `stemmer` (int), `tid` (timestamp), `hvemstemte` (text)

SQL source files: `website/sql/gullkorn.sql`, `website/sql/gullkorn_clean.sql`
