# 2026-02-14 — Production Deployment to select.huske.app

## Subdomain Setup

Created `select.huske.app` subdomain to serve the Laravel app via Docker.

### 1. Apache Virtual Host

Created `/etc/apache2/sites-available/select-huske.conf` — reverse proxy to Docker container on port 8000:

```apache
<VirtualHost *:80>
    ServerName select.huske.app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    ErrorLog ${APACHE_LOG_DIR}/select-huske-error.log
    CustomLog ${APACHE_LOG_DIR}/select-huske-access.log combined
</VirtualHost>
```

Enabled with `sudo a2ensite select-huske.conf && sudo systemctl reload apache2`.

### 2. DNS (GoDaddy)

Added A record for `select` pointing to `185.14.97.143` (same IP as huske.app) with 600s TTL.

### 3. SSL Certificate

```bash
sudo certbot --apache -d select.huske.app
```

Certbot auto-created `select-huske-le-ssl.conf` and added HTTPS redirect to the HTTP vhost.

### 4. Docker Engine Installation

Docker was not installed on the server. Installed Docker Engine for Debian Bullseye:

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bullseye stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo groupadd docker
sudo usermod -aG docker terje
newgrp docker
```

Note: `sudo apt install docker` installs `wmdocker` (a window manager dock), NOT Docker Engine.

### 5. Production .env

Created `website/.env` with key differences from `.env.example`:

| Setting | Dev | Production |
|---------|-----|------------|
| APP_ENV | local | production |
| APP_DEBUG | true | false |
| APP_URL | http://select.test:8000 | https://select.huske.app |
| DB_EXTERNAL_PORT | 5432 | 5433 (host PostgreSQL on 5432) |
| REVERB_PORT | 8080 | 8082 (8080/8081 in use by other sites) |
| LOG_LEVEL | debug | warning |

### 6. Docker Startup & Fix

```bash
cd /home/terje/sites/select-app/website
docker compose up -d
```

Setup container ran successfully (composer install, key generate, migrations).

**500 error fix** — storage directories not writable:

```bash
docker compose exec app chmod -R 775 storage bootstrap/cache
docker compose exec app chown -R www-data:www-data storage bootstrap/cache
```

## Server Architecture

```
Browser → select.huske.app (HTTPS/443)
       → Apache reverse proxy
       → localhost:8000
       → Docker: select-nginx container
       → Docker: select-app (PHP-FPM)
       → Docker: select-db (PostgreSQL on internal network, exposed on host:5433)
```

## Port Allocations on Server

| Port | Service |
|------|---------|
| 8000 | Select app (Docker nginx) |
| 8080 | dev.ekstremedia.no Reverb |
| 8081 | ekstremedia.no Reverb |
| 8082 | Select Reverb (reserved, not yet active) |
| 5432 | Host PostgreSQL |
| 5433 | Select PostgreSQL (Docker, external) |

---

## Welcome Page — Vue 3 + PrimeVue v4 + Tailwind v4

Replaced the default Laravel 12 welcome page with a game-branded Vue 3 SPA.

### Frontend Stack Installed

```bash
cd website
yarn add vue @vitejs/plugin-vue primevue @primeuix/themes tailwindcss-primeui
```

### Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `package.json` | Modified | Added Vue 3, PrimeVue v4, Tailwind-PrimeUI deps |
| `vite.config.js` | Modified | Added `@vitejs/plugin-vue` plugin |
| `resources/js/app.js` | Rewritten | Vue 3 app + PrimeVue with Aura theme |
| `resources/css/app.css` | Modified | Added `tailwindcss-primeui`, `.vue` source scanning, class-based dark mode |
| `resources/js/composables/useI18n.js` | New | NO/EN i18n with localStorage persistence |
| `resources/js/composables/useDarkMode.js` | New | Dark/light toggle, system preference detection |
| `resources/js/pages/Welcome.vue` | New | Full welcome page component |
| `resources/views/welcome.blade.php` | Rewritten | Minimal Vue mount shell |
| `tests/Feature/WelcomePageTest.php` | New | PHPUnit tests for welcome route |

### Welcome Page Features

- **Hero**: Large "SELECT" title, animated acronym tiles (letters appear one by one, then sentence forms)
- **How to play**: 4-step card grid explaining the game
- **Example**: Letter tiles spelling S-E-L-E-C-T with example answer
- **CTA**: PrimeVue buttons — "Play now" / "Get the app"
- **Dark/light mode**: Toggle button, persists to localStorage, respects system preference
- **Language**: NO/EN toggle, Norwegian default, persists to localStorage
- **Responsive**: Mobile-first design with sm: breakpoints

### Tailwind v4 Dark Mode Fix

Tailwind v4 defaults to `@media (prefers-color-scheme: dark)` for `dark:` variants. For class-based toggle (`.dark` on `<html>`), added to `app.css`:

```css
@variant dark (&:where(.dark, .dark *));
```

### HTTPS Mixed Content Fix

Assets were generating `http://` URLs because Apache terminates SSL and proxies to Docker over HTTP. Two fixes applied:

1. **`bootstrap/app.php`**: Added `$middleware->trustProxies(at: '*')` to trust all proxies
2. **`AppServiceProvider.php`**: Added `URL::forceScheme('https')` in production

### Build

```bash
cd website && yarn build
```

Assets compiled to `public/build/` (~320KB JS, ~25KB CSS gzipped).

---

## Gullkorn Import Command

Created `php artisan gullkorn:import` to import legacy sentence data from the original IRC #select game.

### Problem

SQL files are MySQL dumps (backtick quoting, `ENGINE=InnoDB`, `LOCK TABLES`, `AUTO_INCREMENT`). Database is PostgreSQL.

### Solution

The command (`app/Console/Commands/ImportGullkornCommand.php`):
1. Creates PostgreSQL-native tables (SERIAL, TIMESTAMP)
2. Parses MySQL INSERT VALUES tuples with a custom parser (handles escaped quotes, commas in strings)
3. Converts MySQL-invalid dates (`2000-00-00`) to NULL
4. Batch inserts 500 rows at a time
5. Resets PostgreSQL sequences to max(id)

### Usage

```bash
dc exec select php artisan gullkorn:import                        # Both tables
dc exec select php artisan gullkorn:import --only=gullkorn_clean  # One table
```

### Tables

| Table | Description |
|-------|-------------|
| `gullkorn` | Original sentences, all data from #select |
| `gullkorn_clean` | Curated/cleaned version |

Both tables: `id`, `nick` (varchar 9), `setning` (text), `stemmer` (int), `tid` (timestamp), `hvemstemte` (text)

SQL source files: `website/sql/gullkorn.sql`, `website/sql/gullkorn_clean.sql`

---

## Phase 1: Authentication & User System

Implemented the full authentication and user system for the SELECT game API.

### Dependencies Added

- `pragmarx/google2fa-laravel` — TOTP-based two-factor authentication
- `bacon/bacon-qr-code` — QR code generation for 2FA setup

### Database Migrations (4 new)

| Migration | Purpose |
|-----------|---------|
| `2026_02_14_100001_add_auth_fields_to_users_table` | nickname, role, ban fields, 2FA fields, avatar_url |
| `2026_02_14_100002_update_players_table_for_auth` | Rename display_name→nickname, add is_guest, last_active_at |
| `2026_02_14_100003_create_banned_ips_table` | IP banning for guests |
| `2026_02_14_212135_create_personal_access_tokens_table` | Published from Sanctum (needed for tests) |

### Codebase-wide Rename: `display_name` → `nickname`

Updated across all models, controllers, actions, events, broadcasts, seeders, routes, views, and tests.

### Models Updated/Created

- **User** — Added fillable auth fields, encrypted 2FA casts, `isAdmin()`, `isBanned()`, `hasTwoFactorEnabled()`, `player()` relationship
- **Player** — nickname field, `is_guest` boolean, `touchLastActive()`, factory resolver
- **BannedIp** — New model for IP-based bans

### Middleware (4 new in `app/Application/Http/Middleware/`)

| Middleware | Purpose |
|-----------|---------|
| `ResolvePlayer` | Global API — resolves player from X-Guest-Token or Sanctum bearer |
| `RequirePlayer` | Returns 401 if no player resolved |
| `EnsureNotBanned` | Checks user and IP bans, returns 403 |
| `RequireAdmin` | Checks admin role, returns 403 |

### Form Requests (9 new in `app/Application/Http/Requests/Api/V1/`)

GuestRequest, RegisterRequest, LoginRequest, ConvertGuestRequest, ForgotPasswordRequest, ResetPasswordRequest, TwoFactorConfirmRequest, TwoFactorDisableRequest, BanPlayerRequest

### Domain Actions (2 new, 2 updated)

- **BanPlayerAction** — Bans user and optionally creates IP ban
- **UnbanPlayerAction** — Clears ban fields
- **CreateGuestPlayerAction** — Updated: display_name→nickname, sets is_guest=true
- **ConvertGuestToUserAction** — Updated: accepts nickname param, sets is_guest=false

### Controllers (2 new, 3 refactored)

- **TwoFactorController** — enable/confirm/disable 2FA with TOTP
- **AdminController** — Player list, game list, ban/unban
- **AuthController** — Refactored: Form Requests, middleware-resolved player, added logout/forgotPassword/resetPassword, 2FA login flow
- **GameController** / **RoundController** — Removed duplicate `getPlayer()`, use middleware-resolved player

### Routes Restructured (`routes/api.php`)

- Public: guest, register, login, forgot-password, reset-password
- Sanctum-protected: logout, convert, 2FA
- Player+banned middleware: me, games, rounds
- Admin-only: admin routes

### Other New Files

- `CleanupExpiredGuestsJob` — Daily job to delete inactive guests (>24h, not in active games)
- `WelcomeMail` + blade template
- `AccountBannedMail` + blade template
- `UserSeeder` — Admin (Terje/Godskalk) + test user
- `PlayerFactory` — guest/registered states

### Tests: 81 passing (API + Middleware)

| Test File | Tests | Description |
|-----------|-------|-------------|
| `AuthTest` | 7 | Updated existing tests for nickname |
| `GameTest` | 10 | Fixed with Bus::fake for ProcessAnswerDeadlineJob |
| `RoundTest` | 7 | Fixed with Bus::fake for ProcessAnswerDeadlineJob |
| `AuthGuestTest` | 9 | Guest nickname validation, uniqueness |
| `AuthRegistrationTest` | 10 | Registration, guest conversion |
| `AuthLoginTest` | 8 | Login, banned, logout |
| `AuthPasswordResetTest` | 7 | Forgot/reset password flow |
| `TwoFactorTest` | 8 | 2FA enable/confirm/disable |
| `AdminTest` | 9 | Admin CRUD, access control |
| `BannedMiddlewareTest` | 5 | Ban enforcement |

### Issues Fixed During Implementation

1. **Sanctum migrations not published** — `personal_access_tokens` table missing in SQLite tests
2. **PlayerFactory not found** — Model in non-standard namespace; added `newFactory()` to Player
3. **`ilike` not in SQLite** — Changed AdminController to use `like` (case-insensitive by default)
4. **Password reset route undefined** — Added `ResetPassword::createUrlUsing()` in AppServiceProvider
5. **Sanctum user not resolved in global middleware** — Used `Auth::guard('sanctum')->user()` explicitly
6. **ProcessAnswerDeadlineJob sync queue issue** — Added `Bus::fake()` to GameTest/RoundTest setUp

### Known Pre-existing Failures (not Phase 1)

- 6 WelcomePageTest + ExampleTest failures — `gullkorn_clean` table doesn't exist in SQLite test DB

---

## Phases 2–7: Full Web Frontend & Game Backend

Implemented all remaining phases of the SELECT game in a single session. All 117 tests pass (564 assertions).

### Phase 2: Vue Frontend Foundation & Routing

**Dependencies installed** (on host via yarn):
- `vue-router@4`, `pinia`, `laravel-echo`, `pusher-js`, `howler`, `vitest`, `@vue/test-utils`, `happy-dom`

**Core infrastructure created:**

| File | Purpose |
|------|---------|
| `resources/js/router.js` | Vue Router 4 with 17 routes, auth guards |
| `resources/js/services/api.js` | Axios API client with auth interceptors |
| `resources/js/services/websocket.js` | Laravel Echo + Pusher.js WebSocket client |
| `resources/js/stores/authStore.js` | Pinia auth store (guest/login/register/logout) |
| `resources/js/stores/gameStore.js` | Pinia game store (full game state machine) |
| `resources/js/stores/soundStore.js` | Howler.js sound effects store |
| `resources/js/composables/useViewport.js` | Viewport size composable |
| `resources/js/layouts/AppLayout.vue` | App shell with nav, dark mode, language |
| `resources/js/layouts/GameLayout.vue` | Minimal game layout |
| `resources/js/App.vue` | Root component with router-view |
| `resources/js/app.js` | Entry point (Vue+PrimeVue+Pinia+Router) |

**SPA setup:**
- `routes/web.php` — Catch-all route serving `welcome.blade.php` for SPA
- `welcome.blade.php` — Vue mount shell with `data-gullkorn` attribute

### Phase 3: Game Management

**New Form Requests:**
- `CreateGameRequest` — validates settings, is_public, password
- `JoinGameRequest` — validates optional password

**Updated Domain Actions:**
- `CreateGameAction` — Added `$isPublic` and `$password` params (Hash::make)
- `JoinGameAction` — Added `$password` param (Hash::check validation)
- `StartGameAction` — Added `started_at => now()`

**GameController additions:**
- `index()` — Public game listing via `Game::publicLobby()` scope
- `state()` — Full game state for reconnection (round, my_answer, my_vote, answers, completed_rounds)
- `chat()` — In-game chat broadcasting
- Updated `store()` and `join()` to use Form Requests and pass is_public/password

### Phase 4: Core Gameplay Loop

**New broadcast event:**
- `ChatMessageBroadcast` — In-game chat message via presence channel

**New Form Requests:**
- `SubmitAnswerRequest` — validates text (required, string, max:500)
- `SubmitVoteRequest` — validates answer_id (required, uuid, exists:answers)

**GameProcessor (Delectus) update:**
- Added `time_between_rounds` setting support — delays next round start based on `updated_at` of last completed round

**17 Vue pages created:**
- Auth: Login, Register, ForgotPassword, ResetPassword
- Game: Games (browse/join), CreateGame, JoinGame, Game (full gameplay), GameSpectate
- Data: Archive, ArchiveGame, Leaderboard, HallOfFame, Profile, ProfileSettings
- Admin, NotFound

### Phase 5: Data Persistence, Stats & Leaderboard

**Database migrations (4 new):**

| Migration | Purpose |
|-----------|---------|
| `2026_02_14_200001_add_game_discovery_fields` | is_public, password, started_at, finished_at, duration_seconds on games |
| `2026_02_14_200002_add_denormalized_fields` | author_nickname on answers, voter_nickname on votes |
| `2026_02_14_200003_create_game_results_table` | Denormalized finished game results |
| `2026_02_14_200004_create_hall_of_fame_and_player_stats` | Hall of fame entries + player stats |

**New models:** GameResult, HallOfFame, PlayerStat (with factories)

**EndGameAction rewrite:** Now saves finished_at, duration_seconds, GameResult, HallOfFame entries (for answers with votes), and updates PlayerStat for registered users.

**New controllers:**
- `ArchiveController` — Paginated game results (with period/player filters), game detail by code
- `LeaderboardController` — Sorted player stats with configurable sort parameter
- `HallOfFameController` — Paginated winning sentences + random classic sentence endpoint
- `PlayerProfileController` — Profile show + stats/sentences/games sub-endpoints

**New API routes (public, no auth):**
- `GET /archive`, `GET /archive/{code}`
- `GET /leaderboard`
- `GET /hall-of-fame`, `GET /hall-of-fame/random`
- `GET /players/{nickname}`, `/stats`, `/sentences`, `/games`

### Phase 6: Admin Dashboard

Admin.vue created with full implementation:
- Players tab: searchable list, ban/unban with dialog
- Games tab: paginated game list with status badges
- Stats tab: summary cards

### Phase 7: Polish & Testing

**Tests added (Phase 3-5):**

| Test File | Tests | Description |
|-----------|-------|-------------|
| `GameCreationTest` | 8 | Public games, password protection, game listing, state |
| `ArchiveTest` | 8 | Archive CRUD, leaderboard sorting, hall of fame, player profiles |

**Total: 117 tests, 564 assertions, all passing in 1.84s**

**Frontend build:** 346 modules, ~438KB JS + ~38KB CSS (gzipped ~118KB + ~7KB)

**FinishedGameSeeder:** Creates 5 sample finished games with rounds, answers, votes, HallOfFame, GameResult, and PlayerStat data for testing data display pages.

### Files Summary

**New files (~45):** 4 migrations, 3 models, 4 form requests, 1 broadcast event, 4 controllers, 1 seeder, 17 Vue pages, 5 core JS files (router, api, websocket, stores), 2 layouts, 2 test files

**Modified files (~15):** GameController, RoundController, ArchiveController, HallOfFameController, PlayerProfileController, GameProcessor, CreateGameAction, JoinGameAction, StartGameAction, EndGameAction, routes/api.php, routes/web.php, welcome.blade.php, app.js, App.vue, Welcome.vue, Games.vue, Profile.vue, package.json, vite.config.js
