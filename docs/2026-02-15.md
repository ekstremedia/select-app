# 2026-02-15 — Feature Completion & Polish

Continued from Feb 14 where Phases 1-7 were implemented. Today's work focused on
filling implementation gaps, adding frontend tests, and fixing broken functionality.

## Commits

| Hash | Description |
|------|-------------|
| `07ba918` | Add Vitest frontend tests for Vue composables and Pinia stores |
| `c08a751` | Add profile management and admin stats endpoints |
| `965376c` | Add password change endpoint and guest-to-user conversion flow |

## Vitest Frontend Tests (76 tests)

Created 5 test files covering all Vue composables and Pinia stores:

| Test File | Tests | Key Coverage |
|-----------|-------|--------------|
| `useI18n.test.js` | 6 | Translation, locale toggle, persistence |
| `useDarkMode.test.js` | 7 | System preference, toggle, class/localStorage sync |
| `authStore.test.js` | 22 | All auth flows, computed props, storage |
| `gameStore.test.js` | 34 | State machine, API calls, WebSocket lifecycle |
| `soundStore.test.js` | 7 | Enable/disable, volume, localStorage |

**Testing patterns established:**
- `vi.resetModules()` + dynamic `import()` for module-level Vue refs
- `await nextTick()` after mutations to assert Vue watcher side-effects
- `vi.mock()` for API, WebSocket, and sound store modules
- `createPinia()` / `setActivePinia()` for store isolation

## New API Endpoints

### Profile Management
| Method | Route | Purpose |
|--------|-------|---------|
| `PATCH` | `/api/v1/profile/nickname` | Update nickname (3-20 chars, unique) |
| `PATCH` | `/api/v1/profile/password` | Change password (requires current_password) |
| `DELETE` | `/api/v1/profile` | Delete account (Sanctum auth required) |

### Admin Stats
| Method | Route | Purpose |
|--------|-------|---------|
| `GET` | `/api/v1/admin/stats` | Server-side stats (players, games, active today, etc.) |

### New Files Created
- `UpdateNicknameRequest.php` — Validation with unique:players ignore-self
- `UpdatePasswordRequest.php` — current_password + confirmed rules
- `ProfileTest.php` — 10 tests covering nickname, password, delete

## Bugs Fixed

### 1. Password Change Was Broken
ProfileSettings.vue was calling `api.auth.resetPassword()` (the forgot-password flow)
instead of a proper authenticated password change endpoint. The reset endpoint expects
`token` + `email`, not `current_password`.

**Fix:** Created `PATCH /profile/password` with `UpdatePasswordRequest` that uses
Laravel's built-in `current_password` validation rule.

### 2. Guest-to-User Conversion Missing from Frontend
The backend `POST /auth/convert` endpoint existed but was never called from the frontend.
Guest players had no way to create an account while preserving their stats.

**Fix:**
- Added `convertGuest()` action to `authStore.js`
- Updated `Register.vue` to detect guest sessions and use convert flow
- Pre-fills nickname from guest session
- Shows conversion notice banner
- Hides "play as guest" section when already a guest

### 3. Admin Stats Were Hardcoded
Admin.vue stats tab showed `active_today: 0` and `games_today: 0` because it was
calculating from local data instead of a server endpoint.

**Fix:** Created `GET /admin/stats` endpoint returning 7 metrics from real DB queries.
Updated Admin.vue to load stats in parallel with players/games.

## Test Totals

| Suite | Tests | Assertions |
|-------|-------|------------|
| PHPUnit (backend) | 154 passed, 1 skipped | 716 |
| Vitest (frontend) | 76 passed | — |
| **Total** | **230** | — |

## Inertia.js v2 Migration

Migrated from Vue Router SPA to Inertia.js v2 ("Thin Inertia" approach — Inertia handles
routing/navigation only, all data fetching stays via existing API service).

**Files changed:** 2 layouts, 19 pages, app.js, web.php, websocket.js, bootstrap/app.php
**Files created:** HandleInertiaRequests middleware, app.blade.php, useAuthGuard.js, ErrorPage.vue
**Files deleted:** router.js, App.vue
**Deps:** Added `@inertiajs/vue3`, `inertiajs/inertia-laravel`; removed `vue-router`

## Bugs Fixed During Migration

### 4. WebSocket Auth Fails for Logged-In Users (Critical)

**Symptom:** Host creates a game and waits in the lobby. A guest joins the game in another
browser. The host does NOT see the player join. But when the host leaves, the guest DOES
see them leave. Partial reactivity — some events work, some don't.

**Root cause:** The broadcast auth endpoint (`POST /api/broadcasting/auth`) is registered
in `routes/web.php`. The `BroadcastAuthController::getPlayer()` method tried two things:

1. Guest token via `X-Guest-Token` header — works for guests
2. `$request->user()` — uses **session auth**, NOT Bearer tokens

When a user logs in, the frontend stores a Sanctum Bearer token in localStorage and
**removes** the guest token. The websocket.js authorizer sends `Authorization: Bearer {token}`
to the broadcast auth endpoint. But because it's a web route (not API route), `$request->user()`
doesn't recognize Bearer tokens — it only checks the session cookie. Result: `getPlayer()`
returns null, the endpoint returns 403, and **the host's presence channel subscription
silently fails**. They never receive any broadcast events.

The reason the host's *leave* event still reached the guest is that `.player.left` is
broadcast server-side from the HTTP controller (`broadcast()->toOthers()`), not from the
WebSocket. The guest IS successfully subscribed (guest tokens work), so they receive it.

**Fix:** Added Sanctum Bearer token lookup as a fallback in `getPlayer()`:
```php
$bearerToken = $request->bearerToken();
if ($bearerToken) {
    $tokenModel = PersonalAccessToken::findToken($bearerToken);
    if ($tokenModel) {
        return Player::where('user_id', $tokenModel->tokenable_id)->first();
    }
}
```

**File:** `app/Application/Http/Controllers/Api/V1/BroadcastAuthController.php`

**Lesson:** When a custom broadcast auth endpoint lives on a web route but clients
authenticate with API tokens (Sanctum Bearer), `$request->user()` won't work. You must
manually resolve the token. This is easy to miss because WebSocket auth failures are
silent on the client side — the presence channel just never fires events.

### 5. Games List Doesn't Auto-Update

**Symptom:** Create a game in one browser, the `/games` page in another browser doesn't
show it until manual refresh.

**Root cause:** `Games.vue` only fetched the game list on mount with no polling.

**Fix:** Added 10-second polling interval with cleanup on unmount.

**File:** `resources/js/pages/Games.vue`

### 6. Broadcast Field Name Mismatch Breaks Timer + Answer Submission (Critical)

**Symptom:** Three cascading bugs:
- Guest player's timer and progress bar don't count down after game starts
- Host gets "Server Error" when submitting an answer
- Game state corrupted on refresh

**Root cause:** Field name mismatch between HTTP API responses and WebSocket broadcast events.

The `RoundStartedBroadcast` event sends:
```json
{"round_id": "uuid", "deadline": "2026-02-15T12:34:56Z", "acronym": "TIHWP"}
```

But `_setRound()` in `gameStore.js` expected:
- `roundData.id` (not `round_id`) → `currentRound.id` becomes undefined
- `roundData.answer_deadline` (not `deadline`) → countdown never starts

Additionally, `GameController::start()` broadcasts to ALL players (no `toOthers()`), so the
HOST receives the broadcast too, overwriting the correct data from the HTTP response.

Effect chain for host:
1. HTTP response sets `currentRound.id` = correct UUID
2. Broadcast arrives and `_setRound(data)` overwrites it → `currentRound.id` = undefined
3. Host submits answer → `POST /api/v1/rounds/undefined/answer`
4. Postgres UUID column gets "undefined" → SQL error → 500

**Fix:** Normalize field names in `_setRound()`:
```js
currentRound.value = { ...roundData, id: roundData.id || roundData.round_id };
const answerDeadline = roundData.answer_deadline || roundData.deadline;
```

**File:** `resources/js/stores/gameStore.js`

**Lesson:** When WebSocket broadcast events and HTTP API responses feed the same state
function, their field names MUST match — or the function must normalize them. Always check
what `broadcastWith()` returns vs what the API controller returns.

### 7. "Player already in game" Error on Games List

**Symptom:** Clicking a game you're already in shows an error instead of navigating to it.

**Fix:** In `Games.vue`, catch the "already in game" 422 and navigate anyway.

**File:** `resources/js/pages/Games.vue`

## Status

Inertia.js v2 migration complete. All 7 phases of SELECT-PLAN.md are fully implemented
and tested. WebSocket presence channels work for both guest and logged-in users.

**Remaining non-code work:**
- Replace placeholder MP3 sound files with real audio
- Deploy latest commits to production
