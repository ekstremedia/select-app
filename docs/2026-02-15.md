# 2026-02-15 — Feature Completion & Polish

Continued from Feb 14 where Phases 1-7 were implemented. Today's work focused on
filling implementation gaps, adding frontend tests, and fixing broken functionality.

## Commits

| Hash | Description |
|------|-------------|
| `07ba918` | Add Vitest frontend tests for Vue composables and Pinia stores |
| `c08a751` | Add profile management and admin stats endpoints |
| `965376c` | Add password change endpoint and guest-to-user conversion flow |

## Vitest Frontend Tests (76 tests)

Created 5 test files covering all Vue composables and Pinia stores:

| Test File | Tests | Key Coverage |
|-----------|-------|--------------|
| `useI18n.test.js` | 6 | Translation, locale toggle, persistence |
| `useDarkMode.test.js` | 7 | System preference, toggle, class/localStorage sync |
| `authStore.test.js` | 22 | All auth flows, computed props, storage |
| `gameStore.test.js` | 34 | State machine, API calls, WebSocket lifecycle |
| `soundStore.test.js` | 7 | Enable/disable, volume, localStorage |

**Testing patterns established:**
- `vi.resetModules()` + dynamic `import()` for module-level Vue refs
- `await nextTick()` after mutations to assert Vue watcher side-effects
- `vi.mock()` for API, WebSocket, and sound store modules
- `createPinia()` / `setActivePinia()` for store isolation

## New API Endpoints

### Profile Management
| Method | Route | Purpose |
|--------|-------|---------|
| `PATCH` | `/api/v1/profile/nickname` | Update nickname (3-20 chars, unique) |
| `PATCH` | `/api/v1/profile/password` | Change password (requires current_password) |
| `DELETE` | `/api/v1/profile` | Delete account (Sanctum auth required) |

### Admin Stats
| Method | Route | Purpose |
|--------|-------|---------|
| `GET` | `/api/v1/admin/stats` | Server-side stats (players, games, active today, etc.) |

### New Files Created
- `UpdateNicknameRequest.php` — Validation with unique:players ignore-self
- `UpdatePasswordRequest.php` — current_password + confirmed rules
- `ProfileTest.php` — 10 tests covering nickname, password, delete

## Bugs Fixed

### 1. Password Change Was Broken
ProfileSettings.vue was calling `api.auth.resetPassword()` (the forgot-password flow)
instead of a proper authenticated password change endpoint. The reset endpoint expects
`token` + `email`, not `current_password`.

**Fix:** Created `PATCH /profile/password` with `UpdatePasswordRequest` that uses
Laravel's built-in `current_password` validation rule.

### 2. Guest-to-User Conversion Missing from Frontend
The backend `POST /auth/convert` endpoint existed but was never called from the frontend.
Guest players had no way to create an account while preserving their stats.

**Fix:**
- Added `convertGuest()` action to `authStore.js`
- Updated `Register.vue` to detect guest sessions and use convert flow
- Pre-fills nickname from guest session
- Shows conversion notice banner
- Hides "play as guest" section when already a guest

### 3. Admin Stats Were Hardcoded
Admin.vue stats tab showed `active_today: 0` and `games_today: 0` because it was
calculating from local data instead of a server endpoint.

**Fix:** Created `GET /admin/stats` endpoint returning 7 metrics from real DB queries.
Updated Admin.vue to load stats in parallel with players/games.

## Test Totals

| Suite | Tests | Assertions |
|-------|-------|------------|
| PHPUnit (backend) | 154 passed, 1 skipped | 716 |
| Vitest (frontend) | 76 passed | — |
| **Total** | **230** | — |

## Inertia.js v2 Migration

Migrated from Vue Router SPA to Inertia.js v2 ("Thin Inertia" approach — Inertia handles
routing/navigation only, all data fetching stays via existing API service).

**Files changed:** 2 layouts, 19 pages, app.js, web.php, websocket.js, bootstrap/app.php
**Files created:** HandleInertiaRequests middleware, app.blade.php, useAuthGuard.js, ErrorPage.vue
**Files deleted:** router.js, App.vue
**Deps:** Added `@inertiajs/vue3`, `inertiajs/inertia-laravel`; removed `vue-router`

## Bugs Fixed During Migration

### 4. WebSocket Auth Fails for Logged-In Users (Critical)

**Symptom:** Host creates a game and waits in the lobby. A guest joins the game in another
browser. The host does NOT see the player join. But when the host leaves, the guest DOES
see them leave. Partial reactivity — some events work, some don't.

**Root cause:** The broadcast auth endpoint (`POST /api/broadcasting/auth`) is registered
in `routes/web.php`. The `BroadcastAuthController::getPlayer()` method tried two things:

1. Guest token via `X-Guest-Token` header — works for guests
2. `$request->user()` — uses **session auth**, NOT Bearer tokens

When a user logs in, the frontend stores a Sanctum Bearer token in localStorage and
**removes** the guest token. The websocket.js authorizer sends `Authorization: Bearer {token}`
to the broadcast auth endpoint. But because it's a web route (not API route), `$request->user()`
doesn't recognize Bearer tokens — it only checks the session cookie. Result: `getPlayer()`
returns null, the endpoint returns 403, and **the host's presence channel subscription
silently fails**. They never receive any broadcast events.

The reason the host's *leave* event still reached the guest is that `.player.left` is
broadcast server-side from the HTTP controller (`broadcast()->toOthers()`), not from the
WebSocket. The guest IS successfully subscribed (guest tokens work), so they receive it.

**Fix:** Added Sanctum Bearer token lookup as a fallback in `getPlayer()`:
```php
$bearerToken = $request->bearerToken();
if ($bearerToken) {
    $tokenModel = PersonalAccessToken::findToken($bearerToken);
    if ($tokenModel) {
        return Player::where('user_id', $tokenModel->tokenable_id)->first();
    }
}
```

**File:** `app/Application/Http/Controllers/Api/V1/BroadcastAuthController.php`

**Lesson:** When a custom broadcast auth endpoint lives on a web route but clients
authenticate with API tokens (Sanctum Bearer), `$request->user()` won't work. You must
manually resolve the token. This is easy to miss because WebSocket auth failures are
silent on the client side — the presence channel just never fires events.

### 5. Games List Doesn't Auto-Update

**Symptom:** Create a game in one browser, the `/games` page in another browser doesn't
show it until manual refresh.

**Root cause:** `Games.vue` only fetched the game list on mount with no polling.

**Fix:** Added 10-second polling interval with cleanup on unmount.

**File:** `resources/js/pages/Games.vue`

### 6. Broadcast Field Name Mismatch Breaks Timer + Answer Submission (Critical)

**Symptom:** Three cascading bugs:
- Guest player's timer and progress bar don't count down after game starts
- Host gets "Server Error" when submitting an answer
- Game state corrupted on refresh

**Root cause:** Field name mismatch between HTTP API responses and WebSocket broadcast events.

The `RoundStartedBroadcast` event sends:
```json
{"round_id": "uuid", "deadline": "2026-02-15T12:34:56Z", "acronym": "TIHWP"}
```

But `_setRound()` in `gameStore.js` expected:
- `roundData.id` (not `round_id`) → `currentRound.id` becomes undefined
- `roundData.answer_deadline` (not `deadline`) → countdown never starts

Additionally, `GameController::start()` broadcasts to ALL players (no `toOthers()`), so the
HOST receives the broadcast too, overwriting the correct data from the HTTP response.

Effect chain for host:
1. HTTP response sets `currentRound.id` = correct UUID
2. Broadcast arrives and `_setRound(data)` overwrites it → `currentRound.id` = undefined
3. Host submits answer → `POST /api/v1/rounds/undefined/answer`
4. Postgres UUID column gets "undefined" → SQL error → 500

**Fix:** Normalize field names in `_setRound()`:
```js
currentRound.value = { ...roundData, id: roundData.id || roundData.round_id };
const answerDeadline = roundData.answer_deadline || roundData.deadline;
```

**File:** `resources/js/stores/gameStore.js`

**Lesson:** When WebSocket broadcast events and HTTP API responses feed the same state
function, their field names MUST match — or the function must normalize them. Always check
what `broadcastWith()` returns vs what the API controller returns.

### 7. "Player already in game" Error on Games List

**Symptom:** Clicking a game you're already in shows an error instead of navigating to it.

**Fix:** In `Games.vue`, catch the "already in game" 422 and navigate anyway.

**File:** `resources/js/pages/Games.vue`

---

## "Ready/Satisfied" Feature — Auto-Advance to Voting

Added a checkbox feature: after submitting an answer, players can mark "Ok, jeg er fornøyd"
(Ok, I'm satisfied). When ALL active players mark ready, the answering phase skips the
remaining timer and advances straight to voting.

### New Files
- `database/migrations/2026_02_15_add_is_ready_to_answers.php` — `is_ready` boolean on answers
- `app/Domain/Round/Actions/MarkReadyAction.php` — Toggle ready state, auto-advance check
- `app/Application/Broadcasting/Events/PlayerReadyBroadcast.php` — Ready count WebSocket event
- `tests/Feature/Api/RoundReadyTest.php` — 12 tests for the ready feature

### Modified Files
- `Answer` model: added `is_ready` to fillable/casts
- `SubmitAnswerAction`: resets `is_ready = false` when editing an answer
- `RoundController`: new `markReady()` endpoint
- `GameController::state()`: includes `is_ready` on my_answer, `ready_count` in round data
- `BotSubmitAnswerJob`: bots auto-ready after submitting (directly sets `is_ready = true`)
- `routes/api.php`: `POST /rounds/{id}/ready`
- `api.js`: `markReady()` method
- `gameStore.js`: ready count tracking, `.player.ready` WebSocket handler
- `Game.vue`: checkbox UI + "X/Y er klare" counter
- `useI18n.js`: Norwegian/English translations for ready feature

---

## Bot Players in Lobby

Added ability for admin to add/remove bot players from the game lobby.

### Backend
- `CreateBotPlayerAction`: creates bot players with Norwegian names + random suffix
- `BotAnswerService`: finds matching sentences from `gullkorn_clean`, falls back to word bank
- `BotSubmitAnswerJob` / `BotSubmitVoteJob`: dispatched with random delays (3-15s / 2-10s)
- Admin-only: `add_bots: true` in game creation creates 3-5 bot players
- Manual lobby controls: `POST /games/{code}/add-bot` and `POST /games/{code}/remove-bot/{id}`

---

## Answer Edit & Vote Change Tracking

Added `edit_count` to answers and `change_count` to votes tables.

### Migration
- `database/migrations/2026_02_15_141636_add_edit_and_vote_change_counts.php`

### Game Settings
- `max_answer_edits` (default 0 = unlimited) — limits how many times a player can edit
- `max_vote_changes` (default 0 = unlimited) — limits vote changes

---

## Kick, Ban, and Invite Players

- Host/co-host can kick players from game lobby
- Host can ban players from game (prevents rejoin)
- Invite players to game via in-game prompt

---

## CodeRabbit Code Review Fixes

Applied ~30 fixes from a comprehensive CodeRabbit code review covering security,
correctness, and code quality issues.

### Security Fixes
- **User model**: Removed `two_factor_secret`, `two_factor_confirmed_at`, `two_factor_recovery_codes` from `$fillable` to prevent mass-assignment. Updated `TwoFactorController` to use `forceFill()->save()`.
- **CreateBotPlayerAction**: Changed `rand()` to `random_int()` for cryptographic safety

### Bug Fixes
- **RoundController**: Added `withCount('votes')` to completed rounds query (was returning null vote counts)
- **SubmitVoteAction**: Added early return for same-answer vote (prevents wasting a vote change on a no-op)
- **GameController**: Added co-host ban guard (only host can ban co-hosts), added `edit_count` to `my_answer`, added `change_count` to `my_vote` in state response
- **GameProcessor**: Separated ChatMessage and GameFinished broadcasts into individual try-catch blocks
- **ArchiveController**: Added strict comparison to `in_array()`
- **AuthController**: Added WelcomeMail in `convert()` method
- **BotSubmitAnswerJob/BotSubmitVoteJob**: Added `public int $tries = 1` to prevent retries

### Frontend Fixes
- **Game.vue**: Fixed off-by-one in edit/vote change counters, password dialog type="password", excluded ÆØÅ from letter filter, added server-state sync watchers, fixed chat unread delta
- **gameStore.js**: Added bot dedup check in addBot handler
- **ArchiveGame.vue**: Fixed lazy-loaded round answers mapping
- **AppLayout.vue**: Fixed isActive() query param stripping, Tailwind v4 `!` suffix syntax
- **Login.vue/Register.vue**: Fixed `:key` binding in v-for loops
- **Welcome.vue**: Added `g` flag to parseSentence regex

### Email & Config
- All 4 email templates: `lang="und"` → `lang="nb"` for Norwegian
- Account banned email: added mailto contact link
- `.env.example`: removed quotes from MAIL_FROM_ADDRESS

---

## Test Totals (End of Day)

| Suite | Tests | Assertions |
|-------|-------|------------|
| PHPUnit (backend) | 243 passed, 1 skipped | 950 |
| Vitest (frontend) | 76 passed | — |
| **Total** | **319** | — |

## Status

All features implemented and tested. CodeRabbit review fixes applied.
Inertia.js v2 with "thin Inertia" routing pattern working well.

**Remaining non-code work:**
- Replace placeholder MP3 sound files with real audio
- Deploy latest commits to production
